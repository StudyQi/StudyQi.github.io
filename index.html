<!DOCTYPE html>
<html lang="en">
<head>
    <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.css' rel='stylesheet' />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Mobile map</title>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            width: 100vw;
        }
        #button-container {
            position: absolute;
            top: 10px;
            left: 60px;
            z-index: 1000; /* Ensure buttons are rendered above the map */
        }
    </style>
</head>
<body>
    <div id = "map"></div>
    <script>
        L.mapbox.accessToken = 'pk.eyJ1IjoieXFpbmciLCJhIjoiY2xsdzJhMm1mMXpodTNjcHZyc29zaGsxYSJ9.iijVfH5AG9g1Scb_zBYiYA';
        var map = L.map('map').setView([47.40460386239871, 8.54384625978079], 18);
        L.tileLayer('https://api.mapbox.com/styles/v1/yqing/cllwfkv1500fd01qu7knch522/tiles/256/{z}/{x}/{y}@2x?access_token=' + L.mapbox.accessToken,{
            tileSize: 512,
            zoomOffset: -1,
            attribution:'© <a href="https://www.mapbox.com/contribute/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        //Real time location tracker
        class GPSKalmanFilter {
          constructor (decay, variance, minAccuracy) {
          this.decay = decay
          this.variance = variance
          this.minAccuracy = minAccuracy
        }
        process (lat, lng, accuracy, timestampInMs) {
          if (accuracy < this.minAccuracy) accuracy = this.minAccuracy
          if (this.variance < 0) {
          this.timestampInMs = timestampInMs
          this.lat = lat
          this.lng = lng
          this.variance = accuracy * accuracy
          } else {
            const timeIncMs = timestampInMs - this.timestampInMs

            if (timeIncMs > 0) {
              this.variance += (timeIncMs * this.decay * this.decay) / 1000
              this.timestampInMs = timestampInMs
            }

            const _k = this.variance / (this.variance + (accuracy * accuracy))
            this.lat += _k * (lat - this.lat)
            this.lng += _k * (lng - this.lng)

            this.variance = (1 - _k) * this.variance
            }
          return [this.lng, this.lat]
          } 
        }


        var circle;
        let kalmanFilter = new GPSKalmanFilter(10,-1,1)
        var updatedCoords;


        if (! navigator.geolocation){
            console.log('your browser does not support the geolocation')
        } else {
            setInterval(() => {
                navigator.geolocation.getCurrentPosition(getPosition)
            }, 500);
        }
        // Function to get and record current location
        function getPosition(position){
            var Mylat = position.coords.latitude
            var Mylong = position.coords.longitude
            var Myaccuracy = position.coords.accuracy
            var Mytime = new Date().getTime();
            if (circle){
                map.removeLayer(circle)
            }
            updatedCoords= kalmanFilter.process(Mylat, Mylong, Myaccuracy, Mytime)
            circle = L.circle([updatedCoords[1], updatedCoords[0]],{color: '#c65247', fillColor: '#c65247', fillOpacity: 1, radius: 5}).addTo(map) 
            //circle = L.circle([Mylat, Mylong],{color: '#c65247', fillColor: '#c65247', fillOpacity: 1, radius: 5}).addTo(map) 
        }
    </script>
    
</body>
</html>