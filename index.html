<!DOCTYPE html>
<html lang="en">
<head>
    <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
    <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Mobile map</title>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            width: 100vw;
        }
        #button-container {
            position: absolute;
            top: 10px;
            left: 60px;
            z-index: 1000; /* Ensure buttons are rendered above the map */
        }
    </style>
</head>
<body>
    <div id="button-container">
        <button type ="button" id="Route_1">Route1</button>
        <button type ="button" id="Route_2">Route2</button>
        <button type ="button" id="ParticipantID">Participant ID</button>
        <button type ="button" id="startRecording" disabled>Start Recording</button>
        <button type ="button" id="stopRecording" disabled>Stop Recording</button>
        <button type ="button" id="Download_Locations" disabled>Download Locations</button>
        <button type ="button" id="Download_Interactions" disabled>Download Interactions</button>
    </div>
    <div id = "map"></div>
    <script>
        /* MAP */
        mapboxgl.accessToken = 'pk.eyJ1IjoieXFpbmciLCJhIjoiY2xsdzJhMm1mMXpodTNjcHZyc29zaGsxYSJ9.iijVfH5AG9g1Scb_zBYiYA';
        const map = new mapboxgl.Map({
        container: 'map', // container ID
        // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
        style: 'mapbox://styles/yqing/cllwfkv1500fd01qu7knch522', // style URL
        center: [8.54384625978079, 47.40460386239871], // starting position
        zoom: 17 // starting zoom
        });
        map.setMaxZoom(22);
        map.setMinZoom(16);
        map.addControl(new mapboxgl.NavigationControl());
        // Add zoom and rotation controls to the map.
        /*
        map.addControl(
            new mapboxgl.GeolocateControl({
            positionOptions: {
        enableHighAccuracy: true
        },
            // When active the map will receive updates to the device's location as it changes.
            trackUserLocation: true,
            // Draw an arrow next to the location dot to indicate which direction the device is heading.
            showUserHeading: true,
            showAccuracyCircle: false
            })
        );*/
        // Initialize variables for location recording
        let recording = false;
        const recordedLocations = [];
        const recordedInteractions = [];
        var participant;

        // Initialize variables for mapping
        var myRoute
        var desiredLocation 
        var nearestPointOnLine
        var nearestPointCoords
        var Mylat
        var Mylong
        var Myaccuracy
        var Mytime
        var CurrentPoint
        CurrentPoint = {
            'type': 'FeatureCollection',
            'features': [{
            'type': 'Feature',
            'properties': {},
            'geometry': {
            'type': 'Point',
            'coordinates': [8.54384625978079, 47.40460386239871]
            }}]
        };
        /* LOCATION */
        function getPosition(position){
                Mylat = position.coords.latitude
                Mylong = position.coords.longitude
                Myaccuracy = position.coords.accuracy
                Mytime = Date.now()
                if (recording) {
                    recordedLocations.push({Mylat, Mylong, Mytime, Myaccuracy});
                }
            // Display the closest point on the route         
                desiredLocation = {
                    "type": "Feature",
                    "geometry": {
                    "type": "Point",
                    "coordinates": [Mylong, Mylat] 
                    }
                };
                nearestPointOnLine = turf.pointOnLine(myRoute, desiredLocation);
                nearestPointCoords = nearestPointOnLine.geometry.coordinates;
                CurrentPoint.features[0].geometry.coordinates = [nearestPointCoords[0], nearestPointCoords[1]];
                map.getSource('CurrentPoint').setData(CurrentPoint); 
            }
        /* ADD ROUTES */
        document.getElementById('Route_1').addEventListener('click', () => {
            myRoute = {"type": "FeatureCollection", "features": [{"type": "Feature", 
                "geometry": {"type": "LineString", "coordinates": [[8.54516126, 47.4042067], [8.54539571, 47.40459743], 
                [8.54539592, 47.40463866], [8.54535435, 47.40466317], [8.54532359, 47.40467582], [8.5442842, 47.40494541], 
                [8.54446928, 47.405333], [8.54553219, 47.40521497], [8.54590905, 47.40520771], [8.54589698, 47.40557713], 
                [8.5452452, 47.40567516], [8.54326881, 47.4063037], [8.54266823, 47.40542678], [8.54264543, 47.40535417], 
                [8.54268969, 47.40511817], [8.54279698, 47.40514359]]}, 
                "id": "232ee6a8-c4fc-4775-a7e6-a033cf8e6e9b", "properties": {"name": ""}}]}
            map.setCenter([8.544270110877253, 47.40599603821031]);
            map.addSource('CurrentPoint', {
                'type': 'geojson',
                'data': CurrentPoint
            });
            map.addSource('mask',{
                'type': 'geojson',
                'data': {"type": "FeatureCollection", "features": [{"type": "Feature", "geometry": 
                {"type": "Polygon", "coordinates": [[[8.54615373, 47.40370962], [8.54053471, 47.40518459], 
                [8.54213689, 47.40801108], [8.53048195, 47.41594992], [8.51439769, 47.39488037], [8.5540895, 47.38023207], 
                [8.57380569, 47.41047264], [8.5478003, 47.406561], [8.54615373, 47.40370962]]]}, 
                "id": "bc2c8b6a-2a29-403e-9037-9541d0ed1e3c", "properties": {"name": ""}}, {"type": "Feature", "geometry": {"type": "Polygon", "coordinates": 
                [[[8.5478003, 47.406561], [8.54213689, 47.40801108], [8.53048195, 47.41594992], [8.57380569, 47.41047264], [8.5478003, 47.406561]]]}, 
                "id": "78f43455-180b-4c97-b0cc-25380d7f0741", "properties": {"name": ""}}]}
            });
            map.addSource('route', {
                'type': 'geojson',
                'data': myRoute
            });
            map.addLayer({
                'id': 'route',
                'type': 'line',
                'source': 'route',
                'layout': {
                'line-join': 'round',
                'line-cap': 'round'
                },
                'paint': {
                'line-color': '#2b6999',
                'line-width': 13
                    }
            });
            map.addLayer({
                id: 'start', 
                type: 'circle',
                source: {
                type: 'geojson',
                data: {
                type: 'Feature',
                properties: {},
                geometry: {
                type: 'Point',
                coordinates: [8.54516126, 47.4042067], 
                    }
                }
            },
            paint: {
                'circle-radius': 8, 
                'circle-color': '#000000' 
                }
            });
            map.loadImage(
                'https://i.ibb.co/ZgLJrsL/my-icon.png',
                (error, image) => {
                    if (error) throw error;
 
                    // Add the image to the map style.
                map.addImage('my-icon', image);
 
                    // Add a data source containing one point feature.
                map.addSource('point', {
                    'type': 'geojson',
                    'data': {
                    'type': 'FeatureCollection',
                    'features': [
                    {   
                    'type': 'Feature',
                    'geometry': {
                    'type': 'Point',
                    'coordinates': [8.54283698, 47.40517359]
                        }
                    }
                    ]
                    }
                });
 
                    // Add a layer to use the image to represent the data.
                map.addLayer({
                    'id': 'points',
                    'type': 'symbol',
                    'source': 'point', // reference the data source
                    'layout': {
                    'icon-image': 'my-icon', // reference the image
                    'icon-size': 0.07
                    }
                });
                }
            );
            map.addLayer({
                'id': 'mask',
                'type': 'fill',
                'source': 'mask',
                'paint': {
                    'fill-color': 'rgb(255, 255, 255)', 
                    'fill-outline-color': 'rgb(255, 255, 255)'
                }
            });
            map.addLayer({
                'id': 'CurrentPoint', 
                'type': 'circle',
                'source': 'CurrentPoint',
                'paint': {
                'circle-radius': 8, 
                'circle-color': '#c65247' 
                }
                }); 
            setInterval(() => {
                navigator.geolocation.getCurrentPosition(getPosition)
            }, 200);
        // Function to get and record current location
            document.getElementById('Route_1').disabled = true;
            document.getElementById('Route_2').disabled = true;
        });

        document.getElementById('Route_2').addEventListener('click', () => {
            myRoute = {"type": "FeatureCollection", "features": [{"type": "Feature", "geometry": 
                {"type": "LineString", "coordinates": [[8.54516029, 47.40420455], [8.54402571, 47.40451135], 
                [8.54368373, 47.40394313], [8.5428436, 47.40416986], [8.54262232, 47.40423793], [8.54250564, 47.40427696], 
                [8.54240774, 47.40433415], [8.54229241, 47.40442855], [8.54255929, 47.40490599], [8.54237276, 47.40495973], 
                [8.54226547, 47.40499331], [8.54221182, 47.40500057], [8.5421555, 47.40500057], [8.54201333, 47.40497256], 
                [8.54194627, 47.40494714], [8.54152936, 47.4047235], [8.54141615, 47.40466289], [8.54089066, 47.40434268], 
                [8.54110682, 47.40416224], [8.5413669, 47.40390619], [8.5415357, 47.40371433], [8.5416172, 47.40361999], 
                [8.54177266, 47.40345148], [8.54166473, 47.40340355], [8.54138024, 47.40327776], [8.54121608, 47.40317316], 
                [8.54109091, 47.40303374]]}, "id": "a2ee216a-943f-4a61-b975-2e214b5dcf73", "properties": {"name": ""}}]}
            map.setCenter([8.542623755567146, 47.40362428149714]); 
            map.addSource('CurrentPoint', {
                'type': 'geojson',
                'data': CurrentPoint
            });
            map.addSource('route', {
                'type': 'geojson',
                'data': myRoute
            });
            map.addSource('mask',{
                'type': 'geojson',
                'data': {"type": "FeatureCollection", "features": [{"type": "Feature", "geometry": 
                {"type": "Polygon", "coordinates": [[[8.54422257, 47.40067637], [8.53811187, 47.40223786], 
                [8.53844792, 47.40283277], [8.54452548, 47.40124125], [8.54422257, 47.40067637]]]}, 
                "id": "4853ff5b-de6d-4895-a4ae-7b0221c8eff7", "properties": {"name": ""}}, 
                {"type": "Feature", "geometry": {"type": "Polygon", "coordinates": [[[8.54355255, 47.39950313], 
                [8.54422257, 47.40067637], [8.53261289, 47.403643], [8.5320315, 47.40379291], [8.53163575, 47.40264178], 
                [8.54355255, 47.39950313]]]}, "id": "237de5de-b655-4c93-8ff2-84b477f3c28b", "properties": {"name": ""}}, 
                {"type": "Feature", "geometry": {"type": "Polygon", "coordinates": [[[8.54355255, 47.39950313], 
                [8.55212029, 47.39224147], [8.52891886, 47.39645796], [8.53163575, 47.40264178], [8.54355255, 47.39950313]]]}, 
                "id": "432ac056-1fa6-4fc5-b440-bb9870eb8273", "properties": {"name": ""}}, {"type": "Feature", "geometry": 
                {"type": "Polygon", "coordinates": [[[8.54011888, 47.40582865], [8.5381161, 47.40223782], 
                [8.5320315, 47.40379291], [8.53956869, 47.41128904], [8.54011888, 47.40582865]]]}, 
                "id": "bcb69d34-23f4-4f86-bbaa-190d9b3b0fe3", "properties": {"name": ""}}, {"type": "Feature", "geometry": 
                {"type": "Polygon", "coordinates": [[[8.54621114, 47.40425253], [8.54012365, 47.40582732], 
                [8.53956869, 47.41128904], [8.56062101, 47.40669914], [8.55212029, 47.39224147], [8.54355255, 47.39950313], 
                [8.54621114, 47.40425253]]]}, "id": "cba654bf-082f-4dad-8c84-46dd8520edb5", "properties": {"name": ""}}]}
            });
            map.addLayer({
                'id': 'route',
                'type': 'line',
                'source': 'route',
                'layout': {
                'line-join': 'round',
                'line-cap': 'round'
                },
                'paint': {
                'line-color': '#2b6999',
                'line-width': 13
                    }
            });
            map.addLayer({
                    id: 'start', 
                    type: 'circle',
                    source: {
                    type: 'geojson',
                    data: {
                    type: 'Feature',
                    properties: {},
                    geometry: {
                    type: 'Point',
                    coordinates: [8.54516126, 47.4042067] 
                        }
                    }
                },
                paint: {
                    'circle-radius': 8, 
                    'circle-color': '#000000' 
                }
            });

            map.loadImage(
                'https://i.ibb.co/ZgLJrsL/my-icon.png',
                (error, image) => {
                    if (error) throw error;
 
                    // Add the image to the map style.
                map.addImage('my-icon', image);
 
                    // Add a data source containing one point feature.
                map.addSource('point', {
                    'type': 'geojson',
                    'data': {
                    'type': 'FeatureCollection',
                    'features': [
                    {   
                    'type': 'Feature',
                    'geometry': {
                    'type': 'Point',
                    'coordinates': [8.54110091, 47.40305374]
                        }
                    }
                    ]
                    }
                });
 
                    // Add a layer to use the image to represent the data.
                map.addLayer({
                    'id': 'points',
                    'type': 'symbol',
                    'source': 'point', // reference the data source
                    'layout': {
                    'icon-image': 'my-icon', // reference the image
                    'icon-size': 0.07
                    }
                });
                }
            );

            map.addLayer({
                'id': 'mask',
                'type': 'fill',
                'source': 'mask',
                'paint': {
                    'fill-color': 'rgb(255, 255, 255)', 
                    'fill-outline-color': 'rgb(255, 255, 255)'
                }
            });
            map.addLayer({
                'id': 'CurrentPoint', 
                'type': 'circle',
                'source': 'CurrentPoint',
                'paint': {
                'circle-radius': 8, 
                'circle-color': '#c65247' 
                }
                }); 
            setInterval(() => {
                navigator.geolocation.getCurrentPosition(getPosition)
            }, 200);

            document.getElementById('Route_1').disabled = true;
            document.getElementById('Route_2').disabled = true;
        });

        /* RECORDING CONTROL */
        // Function to start recording
        document.getElementById('ParticipantID').addEventListener('click', () => {
            participant = prompt('Please input participant ID', 999);
            document.getElementById('startRecording').disabled = false;
        });

        document.getElementById('startRecording').addEventListener('click', () => {
            recordedLocations.push({recording_start_at: Date.now(),});
            alert("You have started recording");
            recording = true;
            document.getElementById('startRecording').disabled = true;
            document.getElementById('ParticipantID').disabled = true;
            document.getElementById('stopRecording').disabled = false;
            document.getElementById('Download_Locations').disabled = true;
            document.getElementById('Download_Interactions').disabled = true;
            startRecording();
        });
        // Function to stop recording
        document.getElementById('stopRecording').addEventListener('click', () => {
            var r=confirm("Are you sure you want to stop recording?");
                if (r==true)
                {
                recording = false;
                document.getElementById('ParticipantID').disabled = false;
                document.getElementById('startRecording').disabled = false;
                document.getElementById('stopRecording').disabled = true;
                document.getElementById('Download_Locations').disabled = false;
                document.getElementById('Download_Interactions').disabled = false;
                stopRecording();
                }
        });
        // Funcation to download 
        document.getElementById('Download_Locations').addEventListener('click', () => {
            downloadLocations();
        });
        document.getElementById('Download_Interactions').addEventListener('click', () => {
            downloadInteractionData();
        });

        /* INTERACTION */
        function startRecording() {
            map.on('zoomend', recordZoom);
            map.on('moveend', recordPan);
        }

        function recordZoom(event) {
        if (recording) {
            // Record zoom interaction
            var ZoomTime = Date.now();
            recordedInteractions.push({
            type: 'zoom',
            zoomLevel: event.target.getZoom(), 
            latlng_map: event.target.getCenter(), 
            boundingbox: event.target.getBounds(),ZoomTime,
            });
         }
        }

        function recordPan(event) {
        if (recording) {
            // Record pan interaction
            var PanTime = Date.now();
            recordedInteractions.push({
            type: 'pan',
            latlng_map: event.target.getCenter(),
            boundingbox: event.target.getBounds(), PanTime,
            });
         }
        }

        function stopRecording() {
            map.off('zoomend', recordZoom);
            map.off('moveend', recordPan);
        }

        /* DOWNLOAD */
        // Function to download recorded locations as a text file
        function downloadLocations() {
            const data = JSON.stringify(recordedLocations);
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = participant + '_location.txt';
            a.click();
        }

        // Function to download recorded interaction data as a text file
        function downloadInteractionData() {
            const interactionData = JSON.stringify(recordedInteractions);
            const blob = new Blob([interactionData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = participant + '_interaction.txt';
            a.click();
        }
    </script>
    
</body>
</html>